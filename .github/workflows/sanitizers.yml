name: Sanitizers

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  sanitizers:
    name: ${{ matrix.sanitizer }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        sanitizer: [address, undefined, thread]
        compiler: [gcc, clang]
        exclude:
          - os: ubuntu-latest
            sanitizer: thread
            compiler: gcc  # Thread sanitizer requires clang

    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev
    
    - name: Set up ${{ matrix.compiler }}
      if: matrix.compiler == 'gcc'
      run: sudo apt-get install -y gcc-12 g++-12
    
    - name: Set up ${{ matrix.compiler }}
      if: matrix.compiler == 'clang'
      run: sudo apt-get install -y clang-15
    
    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v2.0
    
    - name: Configure with sanitizer
      run: |
        CXX_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -g -O1"
        if [ "${{ matrix.compiler }}" == "gcc" ]; then
          export CC=gcc-12 CXX=g++-12
        else
          export CC=clang-15 CXX=clang++-15
        fi
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="$CXX_FLAGS" \
          -DMASSIVE_BUILD_TESTS=ON
    
    - name: Build
      run: cmake --build build -j$(nproc)
    
    - name: Test
      working-directory: build
      run: ctest --output-on-failure || true

